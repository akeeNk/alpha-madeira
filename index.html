<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Calendar with Animation</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #121212;
        color: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        height: 100vh;
        font-family: Arial, sans-serif;
      }
      #title {
        font-size: 32px;
        margin-top: 20px;
        text-align: center;
      }
      #title span {
        animation: rainbow 1s linear infinite;
      }
      @keyframes rainbow {
        0% {
          color: #ff0000;
        }
        14% {
          color: #ff7f00;
        }
        28% {
          color: #ffff00;
        }
        42% {
          color: #00ff00;
        }
        57% {
          color: #0000ff;
        }
        71% {
          color: #4b0082;
        }
        85% {
          color: #9400d3;
        }
        100% {
          color: #ff0000;
        }
      }
      #countdown {
        font-size: 20px;
        margin: 20px 0;
      }
      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
      }
      .calendar button {
        width: 40px; /* Adjust width as needed */
        height: 40px; /* Adjust height as needed */
        font-size: 12px; /* Adjust font size as needed */
        border: 1px solid #444444;
        cursor: pointer;
        transition: background-color 0.3s;
        text-align: center; /* Center text horizontally */
        line-height: 40px; /* Ensure text vertically centered */
        padding: 0; /* Remove default padding */
      }
      .calendar button.locked {
        background-color: #444444;
      }
      .calendar button.unlocked {
        background-color: #b3b300;
      }
      .calendar button.clicked {
        background-color: #006600;
        pointer-events: none; /* Disable click */
      }
      .credits {
        margin-top: auto;
        padding: 10px 20px;
        text-align: center;
        width: 100%;
        background-color: #121212;
      }
      #animation-container {
        width: 300px; /* Adjust width as needed */
        height: 150px; /* Adjust height as needed */
        margin: 10px 0; /* Add margin to separate from calendar */
        text-align: center;
      }
      #fortune-container {
        margin-top: 10px;
        font-size: 14px;
        text-align: center;
      }
      #fortune-container span {
        animation: rainbow 1s linear infinite;
      }
    </style>
  </head>
  <body>
    <div id="title">
      <span>W</span><span>e</span><span>e</span><span>b</span> <span>T</span
      ><span>r</span><span>i</span><span>p</span> <span>2</span><span>0</span
      ><span>2</span><span>4</span>
    </div>
    <div id="countdown"></div>
    <div class="calendar" id="calendar"></div>
    <div id="animation-container"></div>
    <div id="fortune-container"></div>
    <div class="credits">
      <p>© 2024 Vitor Velosa. All rights reserved.</p>
    </div>

    <!-- Include Luxon library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.2.0/luxon.min.js"></script>
    <!-- Include Lottie library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.4/lottie.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const startDate = new Date("2024-07-11");
        const endDate = new Date("2024-09-04");
        const targetDate = luxon.DateTime.fromISO("2024-09-04T12:00:00", {
          zone: "Asia/Tokyo",
        }); // 4th September, Mid-day in Japan timezone
        const calendarContainer = document.getElementById("calendar");
        const animationContainer = document.getElementById(
          "animation-container"
        );
        const fortuneContainer = document.getElementById("fortune-container");

        const oneDay = 24 * 60 * 60 * 1000; // milliseconds in a day
        const totalDays = Math.round((endDate - startDate) / oneDay) + 1; // total days inclusive

        // Calculate current date in Japan timezone
        const nowInJapan = luxon.DateTime.now().setZone("Asia/Tokyo");
        const currentDay = nowInJapan.day;

        // Countdown Timer
        function updateCountdown() {
          const now = luxon.DateTime.now().setZone("Asia/Tokyo");
          const diff = targetDate.diff(now);

          const { days, hours, minutes, seconds, milliseconds } = diff
            .shiftTo("days", "hours", "minutes", "seconds", "milliseconds")
            .toObject();

          document.getElementById(
            "countdown"
          ).textContent = `${days}d ${hours}h ${minutes}m ${seconds}s ${milliseconds}ms`;

          if (diff.as("milliseconds") < 0) {
            document.getElementById("countdown").textContent =
              "Event has started!";
          }
        }

        setInterval(updateCountdown, 1);

        // Create Calendar
        for (let i = 0; i < totalDays; i++) {
          const date = luxon.DateTime.fromJSDate(startDate)
            .plus({ days: i })
            .setZone("Asia/Tokyo");
          const button = document.createElement("button");
          button.textContent = date.toFormat("LL'/'dd");
          button.classList.add("locked");

          const unlockTime = date.set({
            hour: 12,
            minute: 0,
            second: 0,
            millisecond: 0,
          }); // Mid-day in Japan timezone

          button.addEventListener("click", function () {
            const now = luxon.DateTime.now().setZone("Asia/Tokyo");
            if (now >= unlockTime && !button.classList.contains("clicked")) {
              handleDateClick(
                date,
                button,
                animationContainer,
                fortuneContainer
              );
            }
          });

          // Check if button should be unlocked
          if (nowInJapan >= unlockTime) {
            button.classList.remove("locked");
            button.classList.add("unlocked");
          }

          // Check if the button was clicked previously
          if (localStorage.getItem(date.toISODate())) {
            button.classList.add("clicked");
            const savedData = JSON.parse(
              localStorage.getItem(date.toISODate())
            );
            if (savedData) {
              displayAnimation(savedData.animationData, animationContainer);
              displayFortune(savedData.fortune, fortuneContainer);
            }
          }

          calendarContainer.appendChild(button);
        }

        // Fetch and display animation and fortune
        function handleDateClick(
          date,
          button,
          animationContainer,
          fortuneContainer
        ) {
          fetch("shiba.json") // Adjust the path as necessary
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((animationData) => {
              console.log("Date clicked:", date.toISODate());
              console.log("JSON data:", animationData);

              // Render the animation using Lottie
              displayAnimation(animationData, animationContainer);

              // Generate and display fortune
              const fortune = generateFortune();
              displayFortune(fortune, fortuneContainer);

              // Mark button as clicked
              button.classList.remove("unlocked");
              button.classList.add("clicked");

              // Store the click in local storage
              const savedData = {
                animationData: animationData,
                fortune: fortune,
              };
              localStorage.setItem(date.toISODate(), JSON.stringify(savedData));
            })
            .catch((error) => {
              console.error("Error loading JSON:", error);
            });
        }

        // Display animation
        function displayAnimation(animationData, container) {
          container.innerHTML = "";
          const anim = lottie.loadAnimation({
            container: container,
            renderer: "svg", // Choose the renderer: svg / canvas / html
            loop: true,
            autoplay: true,
            animationData: animationData, // JSON data from fetch response
          });
        }

        // Display fortune
        function displayFortune(fortune, container) {
          container.innerHTML = `<span>Fortune for today: ${fortune}<br>Congratulations on surviving, you're another day closer to Japan</span>`;
        }

        // Generate a random Japanese fortune telling
        function generateFortune() {
          const fortunes = [
            "大吉: Great blessing",
            "中吉: Middle blessing",
            "小吉: Small blessing",
            "吉: Blessing",
            "半吉: Half-blessing",
            "末吉: Future blessing",
            "末小吉: Future small blessing",
            "凶: Curse",
            "小凶: Small curse",
            "半凶: Half-curse",
            "末凶: Future curse",
            "大凶: Great curse",
          ];
          const randomIndex = Math.floor(Math.random() * fortunes.length);
          return fortunes[randomIndex];
        }
      });
    </script>
  </body>
</html>
